<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MP3 Master Editor</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Logo -->
  <img class="logo" src="MP3 Master Editor.png" alt="MP3 Master Editor" title="MP3 Master Editor">

  <div class="container">
    <!-- Tab navigation -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="repeater">MP3 Repeater</button>
      <button class="tab-btn" data-tab="setlist">Set List Creator</button>
      <button class="tab-btn" data-tab="editor">MP3 Editor</button>
    </div>

    <!-- ════════════════════════════════════════════ -->
    <!-- Tab 1: MP3 Repeater                         -->
    <!-- ════════════════════════════════════════════ -->
    <div class="tab-panel active" id="tab-repeater">
      <h2>MP3 Repeater</h2>
      <p class="subtitle">Upload an MP3, choose how many times it repeats, and download the result.</p>

      <div class="upload-area" id="rpt-uploadArea">
        <input type="file" id="rpt-fileInput" accept=".mp3,audio/mpeg">
        <p class="upload-label">Click or drag an MP3 file here</p>
        <p class="file-name" id="rpt-fileName"></p>
      </div>
      <div class="upload-alt">
        or <button class="gdrive-btn" id="rpt-gdriveBtn" disabled>Import from Google Drive</button>
      </div>

      <div class="gdrive-notice" id="rpt-gdriveNotice"></div>

      <div class="controls">
        <label for="rpt-repeatCount">Total plays:</label>
        <input type="number" id="rpt-repeatCount" min="1" max="50" value="3">
        <span class="hint">e.g. 3 = song plays 3 times</span>
      </div>

      <div class="error" id="rpt-errorBox"></div>

      <button class="action-btn" id="rpt-processBtn" disabled>Select an MP3 first</button>

      <div class="progress-wrap" id="rpt-progressWrap">
        <div class="progress-bar"><div class="fill" id="rpt-progressFill"></div></div>
        <p class="progress-text" id="rpt-progressText">Starting...</p>
      </div>

      <div class="result" id="rpt-result">
        <a id="rpt-downloadLink" href="#" download="repeated.mp3">Download Repeated MP3</a>
        <p class="info" id="rpt-resultInfo"></p>
        <div class="preview">
          <p class="preview-label">Preview:</p>
          <audio id="rpt-audioPreview" controls></audio>
        </div>
      </div>
    </div>

    <!-- ════════════════════════════════════════════ -->
    <!-- Tab 2: Set List Creator                     -->
    <!-- ════════════════════════════════════════════ -->
    <div class="tab-panel" id="tab-setlist">
      <h2>Set List Creator</h2>
      <p class="subtitle">Upload your MP3s, arrange them into a set list, and export as one combined MP3.</p>

      <div class="upload-area" id="sl-uploadArea">
        <input type="file" id="sl-fileInput" accept=".mp3,audio/mpeg" multiple>
        <p class="upload-label">Click or drag MP3 files here (multiple)</p>
        <p class="file-name" id="sl-fileStatus"></p>
      </div>
      <div class="upload-alt">
        or <button class="gdrive-btn" id="sl-gdriveBtn" disabled>Import from Google Drive</button>
      </div>

      <div class="gdrive-notice" id="sl-gdriveNotice"></div>

      <div class="file-list" id="sl-fileList" style="display:none;">
        <p class="file-list-title">Uploaded songs:</p>
        <ul class="file-list-items" id="sl-fileListItems"></ul>
      </div>

      <div class="controls">
        <label for="sl-songCount">Songs in set list:</label>
        <input type="number" id="sl-songCount" min="1" max="100" value="3">
        <button class="action-btn" id="sl-buildSlotsBtn" style="width:auto; padding:8px 16px; margin:0; font-size:0.85rem;">Update slots</button>
      </div>

      <div class="setlist-slots" id="sl-slots"></div>

      <div class="error" id="sl-errorBox"></div>

      <button class="action-btn" id="sl-processBtn" disabled>Upload songs &amp; build set list first</button>

      <div class="progress-wrap" id="sl-progressWrap">
        <div class="progress-bar"><div class="fill" id="sl-progressFill"></div></div>
        <p class="progress-text" id="sl-progressText">Starting...</p>
      </div>

      <div class="result" id="sl-result">
        <a id="sl-downloadLink" href="#" download="setlist.mp3">Download Set List MP3</a>
        <p class="info" id="sl-resultInfo"></p>
        <div class="preview">
          <p class="preview-label">Preview:</p>
          <audio id="sl-audioPreview" controls></audio>
        </div>
      </div>
    </div>

    <!-- ════════════════════════════════════════════ -->
    <!-- Tab 3: MP3 Editor                           -->
    <!-- ════════════════════════════════════════════ -->
    <div class="tab-panel" id="tab-editor">
      <h2>MP3 Editor</h2>
      <p class="subtitle">Upload MP3s to the file library, drag them onto tracks, mix with volume &amp; pan, trim, fade, and export.</p>

      <div class="editor-layout">
        <!-- ── Left: Workspace ── -->
        <div class="editor-main">
          <div class="error" id="ed-errorBox"></div>

          <!-- Track toolbar -->
          <div class="editor-track-toolbar">
            <button class="editor-add-track-btn" id="ed-addTrackBtn">+ Add Track</button>
            <span class="editor-track-count" id="ed-trackCount">0 tracks</span>
          </div>

          <!-- Track rows (built by JS) -->
          <div class="editor-tracks" id="ed-tracksContainer"></div>

          <!-- Global timeline waveform -->
          <div class="editor-workspace" id="ed-workspace">
            <div class="waveform-container" id="ed-waveformContainer">
              <div class="waveform-lanes" id="ed-waveformLanes"></div>
              <div class="trim-overlay-left" id="ed-overlayLeft"></div>
              <div class="trim-overlay-right" id="ed-overlayRight"></div>
              <div class="trim-handle trim-handle-left" id="ed-handleLeft"></div>
              <div class="trim-handle trim-handle-right" id="ed-handleRight"></div>
              <div class="playhead" id="ed-playhead"></div>
            </div>

            <div class="trim-times">
              <span>Start: <span class="time-green" id="ed-trimStart">0:00.0</span></span>
              <span>Selection: <span id="ed-trimDuration">0:00.0</span></span>
              <span>End: <span class="time-red" id="ed-trimEnd">0:00.0</span></span>
            </div>

            <!-- Toolbar -->
            <div class="editor-toolbar">
              <button id="ed-playToggle">Play (Space)</button>
              <button id="ed-resetBtn">Reset trim</button>
              <button id="ed-fadeToggle">Fade In/Out</button>
            </div>

            <!-- Fade controls -->
            <div class="effect-controls" id="ed-fadeControls">
              <div class="effect-row">
                <label>Fade in:</label>
                <input type="range" id="ed-fadeIn" min="0" max="10" step="0.1" value="0">
                <span class="range-val" id="ed-fadeInVal">0.0s</span>
              </div>
              <div class="effect-row">
                <label>Fade out:</label>
                <input type="range" id="ed-fadeOut" min="0" max="10" step="0.1" value="0">
                <span class="range-val" id="ed-fadeOutVal">0.0s</span>
              </div>
            </div>

            <!-- Export -->
            <button class="action-btn" id="ed-exportBtn">Export Mixed MP3</button>

            <div class="progress-wrap" id="ed-progressWrap">
              <div class="progress-bar"><div class="fill" id="ed-progressFill"></div></div>
              <p class="progress-text" id="ed-progressText">Starting...</p>
            </div>

            <div class="result" id="ed-result">
              <a id="ed-downloadLink" href="#" download="edited.mp3">Download Edited MP3</a>
              <p class="info" id="ed-resultInfo"></p>
              <div class="preview">
                <p class="preview-label">Preview:</p>
                <audio id="ed-audioPreview" controls></audio>
              </div>
            </div>

            <!-- ── Stem Separation ── -->
            <div class="separator-section" id="ed-separatorSection">
              <div class="section-divider"></div>
              <h3 class="section-heading">Stem Separation</h3>
              <p class="section-subtitle">Separate vocals from instrumental using AI (Demucs v4 via Hugging Face)</p>

              <button class="action-btn separator-btn" id="sep-startBtn" disabled>
                Load an MP3 above first
              </button>

              <div class="separator-status" id="sep-status" style="display:none;">
                <div class="separator-status-icon" id="sep-statusIcon"></div>
                <span id="sep-statusText">Connecting to AI service...</span>
              </div>

              <div class="progress-wrap" id="sep-progressWrap">
                <div class="progress-bar"><div class="fill" id="sep-progressFill"></div></div>
                <p class="progress-text" id="sep-progressText"></p>
              </div>

              <div class="error" id="sep-errorBox"></div>

              <div class="separator-results" id="sep-results" style="display:none;">
                <div class="stem-card">
                  <h4>Vocals</h4>
                  <audio id="sep-vocalsAudio" controls></audio>
                  <a class="stem-download-btn" id="sep-vocalsDownload" href="#" download="vocals.mp3">
                    Download Vocals
                  </a>
                </div>
                <div class="stem-card">
                  <h4>Instrumental</h4>
                  <audio id="sep-instrumentalAudio" controls></audio>
                  <a class="stem-download-btn" id="sep-instrumentalDownload" href="#" download="instrumental.mp3">
                    Download Instrumental
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ── Right: File Library Panel ── -->
        <div class="editor-file-panel">
          <div class="file-panel-header">
            <h3>File Library</h3>
            <div class="upload-area upload-area-compact" id="ed-uploadArea">
              <input type="file" id="ed-fileInput" accept=".mp3,audio/mpeg" multiple>
              <p class="upload-label">Click or drag MP3s here</p>
              <p class="file-name" id="ed-fileName"></p>
            </div>
            <div class="upload-alt">
              or <button class="gdrive-btn" id="ed-gdriveBtn" disabled>Import from Google Drive</button>
            </div>
            <div class="gdrive-notice" id="ed-gdriveNotice"></div>
          </div>
          <div class="file-panel-list" id="ed-libraryList"></div>
          <div class="file-panel-footer" id="ed-libraryFooter"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>MP3 Master Editor &mdash; Browser-based audio tools. Your files stay local.</p>
    <p style="margin-top: 4px;">Vocal separation powered by <a href="https://huggingface.co/spaces/abidlabs/music-separation" target="_blank" rel="noopener">Hugging Face</a></p>
  </footer>

  <!-- Scripts: ORDER MATTERS -->
  <script src="js/utils.js"></script>
  <script src="js/gdrive.js"></script>
  <script src="js/tabs.js"></script>
  <script src="js/repeater.js"></script>
  <script src="js/setlist.js"></script>
  <script src="js/editor.js"></script>
  <script src="js/separator.js"></script>

  <!-- Gradio client (ES module) bridged to global scope -->
  <script type="module">
    import { Client, handle_file } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";
    window._GradioClient = Client;
    window._GradioHandleFile = handle_file;
    window.dispatchEvent(new Event('gradio-ready'));
  </script>
</body>
</html>
